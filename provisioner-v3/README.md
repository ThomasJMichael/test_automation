# Linux Tester Package

## Summary

This is a framework mainly for use in the Linux SW Testing pipeline. It can control cobbler server operations and provision arbitrary boards for use at UUT/UAT pairs for Linux Driver testing.

## Usage

This framework can be used in many ways. The main use case is as an orchestrator for multi-OS testing, but it works just as well as a single-OS test driver. Use as a full provisioner will require some network architecting, which Denver Atwood will be happy to help you with.

All usages will require a configuration repository.

### API Documentation

All usable API classes should be documented in `doc/md`. This documentation can be regenerated by running `python3 setup.py doc` since version [2.0.4](CHANGES.md#204-denver-atwood)

- [Util](doc/md/util.md)  
- [Cobbler](doc/md/cobbler.md)  
- [NFS](doc/md/nfs.md)  
- [Dependencies](doc/md/dependencies.md)  
- [Test](doc/md/test.md)  
- [Validator](doc/md/validator.md)  

### Config Repository structure

      test_repo
      ├── config
      │   └── ssh
      │       ├── config
      │       ├── id_rsa
      │       └── id_rsa.pub
      ├── os.json
      ├── provision.json
      └── scripts
          ├── provision
          │   ├── driver_installers
          │   │   ├── 001_driver_install_script
          │   │   └── ...
          │   ├── postreqs
          │   │   ├── 001_script_to_run_after_installing_packages
          │   │   └── ...
          │   └── prereqs
          │       ├── 001_script_to_run_before_installing_packages
          │       └── ...
          └── test
              └── postscripts
                  ├── 001_script_to_run_after_tests
                  └── ...
          

### Config file structures

- os.json
  * All OS's must be contained within either a 'windows' or linux' group
  * `os['path']` must be a fully qualified path
  * `os['kickstart']` must be relative to the root of the config repo
  * `global` is an optional field
  * `global` may contain dicts or lists to append to individual OS configs

```json
{
    "windows" : {
        "win_type_1" : {
            "path"          : "/path/to/automated/windows_image.iso",
            "profile_name"  : ""
        }    
    },
    "linux" : {
        "os1"   : {
            "path"          : "/path/to/baseimage.iso"            
            "kickstart"     : "config/cobbler/default.ks",       
            "profile_name"  : "name_to_save_in_cobbler",
            "nfs"           : {
## TODO
            },
            "packages"      : [
                "package1",
                "..."
            ],
            "repos"         : [
                {
                    "name" : "repo_filename",
                    "baseurl" : "http://repo_url",
                    "extraoptions" : {
                        "yum_repo_option_to_set" : "option_value"
                    }
                },
                "..."
            ]
        },
        "os2" : {
            "..." : "..."    
        },
        "global"    : {
            "packages"  : [
                "package_for_all_os1",
                "..."
            ],
            "repos"     : [
                {
                    "name" : "universal_repo_filename",
                    "baseurl" : "http://universal_repo_url",
                    "extraoptions" : {
                        "yum_repo_option_to_set" : "option_value"
                    }
                },
                "..."
            ]
        }
    }
}
```

- provision.json
  * All named operating systems should have an exact match in `os.json`
  * `uat` may also be a relative path to another config file in the repo directory
  * postreqs and prereqs are optional. If omitted, run all available scripts every time
    + If you define these fields, make sure the strings exactly match the script names
  * If `use_host_as_uat` is set, the repo will be pulled to the host and run from there

```json
{   
    "test_target" : "friendly_name_for_item_being_tested",
    "mac_address" : "00:11:22:AA:BB:CC",
    "ip_address" : "local IP to assign to UUT",
    "port" : 22,
    "gateway" : "local IP of cobbler server",
    "system_name" : "uat_hostname",
    "dev_username" : "user_to_create",
    "dev_password" : "password_for_user",
    "ksmeta" : {
        "extra_kickstart_variable" : "value",
        "..."
    },
    "os"            : [
        "os1",
        "..."
    ],
    "drivers"       : [
        "001_driver_install_script",
        "..."
    ],
    "test_scripts" : [
        {
            "name" : "logging_name_to_use",
            "repo" : "git@agar:path/to/test_repo.git",
            "branch" : "branch_to_use",
            "use_host_as_uat" : false,
            "commands" : [
                "./script1.sh param1 param2 ...",
                "..."
            ],
            "logs" : "relative/path/to/logs/from/test/root",
            "desc" : "A description of the test"
        }
    ],
    "prereqs" : [
        "001_first_prereq_script",
        "..."
    ],
    "postreqs" : [
        "001_first_postreq_script",
        "..."
    ],
    "post_test_scripts"  : [
        "001_script_to_run_after_test param1 param2 ...",
        "..."
    ],
    "uat" : {
        "mac_address" : "00:11:22:DD:EE:FF",
        "ip_address" : "local IP to assign to UAT",
        "port" : 22,
        "gateway" : "local IP of cobbler server",
        "system_name" : "uat_hostname",
        "dev_username" : "user_to_create",
        "dev_password" : "password_for_user",
        "ksmeta" : {
            "extra_kickstart_variable" : "value",
            "..."
        },
        "os" : [ 
            "os1",
            "..."
        ],
        "drivers" : [
            "001_driver_install_script",
            "..."
        ]
    }
}
```

## Notes

- If you intend to use the Cobbler class, whatever user runs the application will need passwordless sudo access, or to be root itself.
- Test

## Known Bugs and Fixes (listed by version of appearance)

- 0.0.1
  * If using a single system for multiple configurations, make sure the system\_name in both provision.json files is identical, or cobbler gets confused  
- 0.0.1
  * The framework is currently only designed for Yum-managed systems. A fix is to create a script at `/usr/bin/yum` that calls apt/zypper/pacman.
  ```shell
  #!/bin/bash
  # for ubuntu
  $(which apt) $@
  ```

  * Patched in 3.1.2 for apt and zypper


## Contributing

Contact Denver Atwood (denver.atwood@abaco.com) with questions. Please make a merge request if you want to change something.
